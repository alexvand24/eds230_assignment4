---
title: "EDS230 Assignment 4"
author: "Charles Hendrickson, Ryan Munnikhuis, Alex Vand"
date: "4/21/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE, 
                      warning = FALSE)

library(tidyverse)
library(here)
library(pse)

# Read in the atmospheric_conductance R script in order to use the function in this RMD 
source(here("atmospheric_conductance.R"))
```



#Q2
```{r}
# Define variables for height at which wind speed is usually measured.
atmospheric_conductance(v_m = 250, h = 1000)
```


```{r}

# Define sensitivity parameters and inputs for Latin Hypercube Sampling (LHS)
factors = c("v_m", "h", "k_d", "k_0")
```

```{r}
# Number of parameter sets to run
nsets = 100
```

```{r}
# choose distributions for parameters - this would come from
# what you know about the likely range of variation
q = c("qnorm", "qunif", "qnorm", "qnorm")
q_arg = list(list(mean = 250, sd = 30),    # v_m (cm/s)
             list(min = 950, max = 1050),  # h   (cm)
             list(mean = 0.7, sd = 0.01),  # k_d
             list(mean = 0.1, sd = 0.01))  # k_0
             
```


#Q3
(a) Use LHS to generate parameter values for the 4 parameters.

```{r}
# Generate samples for LHS
sens_atmospheric_conductance = LHS(NULL, factors, nsets, q, q_arg)
# Parse data from LHS 
sens_pars = get.data(sens_atmospheric_conductance)
head(sens_pars)
```

(b) Run your atmospheric conductance model for these parameters and return aerodynamic conductance.

```{r}
# lets now run our model for all of the parameters generated by LHS
# pmap is useful here - it is a map function that uses the actual names of input parameters

# The function atmospheric_conductance gets run for each "parameter set" in sens_par
conductance <- sens_pars %>% pmap(atmospheric_conductance)

# notice that what pmap returns is a list 
#head(conductance)

conductance_only <- do.call("rbind", conductance)

conductance_df <- cbind(sens_pars, conductance_only)
  
```


```{r}
# turn results in to a dataframe for easy display/analysis
# add ~^here above

# to take advantage of LHS/pse functions for 
# plotting interesting information we can send results back - 
# results need to be in a matrix
# each column is a different parameter set - we can use transpose (t)
# and as.matrix to get there

# tell is what links output to original LHS object

sens_atmospheric_conductance = pse::tell(sens_atmospheric_conductance,
                                         t(as.matrix(conductance_only)),
                                         res.names = "conductance")
                                              
```



(c) Plot conductance estimates in a way that accounts for parameter uncertainty

**Figure 1: Sensitivity Parameters**
```{r}
# Visualize parameter sensitivity and uncertainty
pse::plotscatter(sens_atmospheric_conductance, col="blue", cex=5)
```

**Figure 2: Partial Rank Correlation Coefficients**

```{r}
# Plots the partial rank correlation coefficient from an LHS object
pse::plotprcc(sens_atmospheric_conductance)

```

```{r}
# partial rank correlation coefficient values from chart above. 
sens_atmospheric_conductance$prcc
```

**Figure 5: Uncertainty Bounds Chart Divided**

```{r}
# note that you don't see the ranges because of the scale (min yield anomaly much smaller than max) - here's a more informative way to graph
tmp = conductance_df %>% gather(value="value", key="yield")
ggplot(tmp, aes(yield, value, col=yield))+
  geom_boxplot()+labs(y="Yield (as anomoly)")+
  facet_wrap(~yield, scales="free" ) + theme_minimal()
```

## Conclusion 

Our results suggest that wind speed ($v_m$) and $k_0$ are the most sensitive parameters for estimating atmospheric conductance, followed by ($h$) and $kd$  (Figure 1  & Figure 2). Wind speed ($v_m$) intuitively makes sense since higher winds can carry away water vapor, drying the air. Interestingly, height had the least sensitivity, suggesting that height measurement values are the least likely to affect the atmospheric conductance outcome. 

- What does it suggest about what you should focus on if you want to reduce uncertainty in aerodynamic conductance estimates?

To reduce uncertainty, measurements should be taken during similar wind speeds and at a fixed point above plants.

- Does this tell you anything about the sensitivity of plant water use to climate change?

Climate change is resulting in hotter, drier, and windier climates. As such, plantsâ€™ evapotranspiration rates are increasing, resulting in a higher sensitivity of plant water use.



